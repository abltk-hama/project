# ai_behavior_rules.md
---

## [PURPOSE]
本ファイルは、AIが本プロジェクトにおいて **どのように判断し・行動するか** を定義する。  
AIはここに記載された行動方針、参照順序、安全規範を厳守し、  
理論整合・構造整合・実装安全を常に保持する。

---

## SECTION 1. BEHAVIOR PRINCIPLES（行動基本方針）

1. すべての行動は **docs/STRUCTURE.md** に記載された階層構造を基準とする。  
2. AIは「理論 → 構造 → 実装 → 出力」の順で思考・提案を行う。  
3. **制御理論・安全性・構造整合性** のいずれかに疑義がある場合、  
   提案前に必ず確認または警告を提示する。  
4. AIは、docs/配下の仕様書を最上位規範とし、  
   各階層 `.md`（controllers.md, models.md 等）を実装責務の基礎資料として扱う。  
5. AIはこれらの文書を唯一の真実源（single source of truth）とし、  
   外部リポジトリ構成・過去会話履歴には依存しない。

---

## SECTION 2. STRUCTURAL CONSISTENCY RULES（構造整合ルール）

1. コード提案・修正は必ず **STRUCTURE.md** に定義された階層依存に従う。  
2. 各ファイルの責務は、対応する `.md` の [RESPONSIBILITY] に準拠する。  
3. 複数階層をまたぐ変更が必要な場合、AIは依存順序を保持した修正順序を提案する。  
4. AIは依存方向を破壊する（上位層から下位層を参照する）提案を禁止とする。  
5. **実機関連コード**（I2C, GPIO, Motor制御など）は `models.real_vehicle` を経由するのみ許可。  

---

## SECTION 3. SAFE UPDATE POLICY（安全な更新ポリシー）

1. mdファイルおよびコードの修正・追加は、ユーザーの明示指示がない限り実行しない。  
2. ユーザー発言がmd内容と矛盾しても、それを「仕様更新」とはみなさず「一時的仮説」として扱う。  
3. 仕様書（md）の更新は、ユーザーが「更新」「反映」など明示的に述べた場合のみ提案する。  
4. 仕様更新提案時は、差分形式または要約形式で変更内容を提示する。  
5. 実装・更新後は `[UPDATE LOG]` を付与し、日付は **M/D/N/B方式** に従う。

---

## SECTION 4. DEEPRESEARCH PROPOSAL POLICY（DeepResearch提案ルール）

### 🎯 概要
AIはレビュー・解析・統合検証を求められた場合、  
タスクの複雑度を5つの基準で評価し、必要に応じてDeepResearchを推奨する。

| 評価項目 | 内容 |
|-----------|------|
| A | 多階層依存があるか |
| B | md未更新・情報不整合があるか |
| C | 実装量・関数数が多いか |
| D | 理論整合チェックが必要か |
| E | 因果分析が必要か |

### 🧩 判定式
`S = wA·A + wB·B + wC·C + wD·D + wE·E（各 w = 0.2）`  
AIは提案感度γ(0.0〜1.0)を文脈から推定し、`S ≥ γ` の場合にDeepResearchを推奨する。

| 感度γ | 性格 | 用途例 |
|-------|------|--------|
| 0.2 | 保守的 | 軽微レビュー・小修正 |
| 0.5 | 標準 | 通常の構造分析・統合 |
| 0.8 | 積極的 | 曖昧・未更新・多依存タスク |

AIは推奨時、3〜5行の要約を提示し、ユーザーの判断を仰ぐ。

---

## SECTION 5. DOCUMENT LOCATION POLICY（ドキュメント配置方針）

### 🎯 基本思想
各階層の `.md` ファイルは外向け仕様書ではなく、  
**内部設計仕様書（開発中の思考補助）**として位置付ける。  
そのため、docs/には共通メタ情報（構造・形式・ルール）のみを配置する。

| 分類 | 配置場所 | 理由 |
|------|-----------|------|
| 各階層の設計仕様書（controllers.md, models.md など） | **階層直下** | コードと理論を同一文脈で扱うため |
| 構造・出力ルール・行動仕様書 | **docs/** | AI・開発者の共通メタ参照用 |
| STRUCTURE.md | **docs/** | 階層間依存を明示するマスター構造 |
| index.md | **docs/** | 人間向けの全体ナビゲーション |

---

## SECTION 6. ACTION PRIORITY（行動優先順位）

AIは以下の優先順位で意思決定を行う：

1. 理論整合性（docs/control_theory.md）  
2. 構造整合性（docs/STRUCTURE.md）  
3. 責務整合性（各階層.md）  
4. 安全性（実機コード保護）  
5. 効率性（処理・開発コスト最適化）

---

## SECTION 7. CHANGE SUMMARY POLICY（修正・追加時の要約提示方針）

### 🎯 目的
AIがコード、Markdown、または仕様書の修正・追加を提案する際、  
ユーザーが変更意図と範囲を即座に理解できるよう、  
**出力冒頭で変更概要を2〜3行に要約して提示する。**

### 🧩 運用ルール
1. **対象:** コード修正・md差分提案などのすべての更新出力  
2. **位置:** 出力またはメッセージの冒頭（3行以内）  
3. **要約内容:**  
   - 対象ファイル名・修正箇所  
   - 修正目的または意図  
   - 変更範囲（任意）  
4. **形式:** 要約の後にコード・差分・全文を出力  
5. **大規模修正:** `## [CHANGE SUMMARY]` セクションを別枠で設けてもよい。

### 💬 例
> 🔧 *修正概要:*  
> - `trajectory_loader.py` に `load_from_excel()` を追加  
> - 目的：Excel経路構造を直接JSONに変換可能にする  
>
> 以下にコードを示します：
> ```python
> def load_from_excel(path: str) -> dict:
>     """Excelファイルから経路データを読み込み、JSON形式で返す。"""
>     ...
> ```

### ✅ 効果
- 変更意図と範囲を即把握でき、レビュー負荷を軽減。  
- 意図しない改変を検知しやすくなる。  
- 複数ファイル提案でも文脈が明確になり、安全性が向上。

---

## SECTION 8. UPDATE LOG

- **2025-10-10N**
  - v1.0 安定版として確定。  
  - DeepResearch動的判定（γ閾値モデル）を正式統合。  
  - Document Location Policyを正式採用（階層直下配置方式）。  
  - CHANGE SUMMARY POLICYを追加（修正・追加時の要約提示）。  
  - 行動・出力・安全ルールの一貫性を確立。  

---
