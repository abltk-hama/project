# PSO適応制御（pso_adaptive）

## 概要
本ドキュメントは、経路追従に用いる **PSO適応制御** の仕様をまとめる。  
PSOは「予測区間内の誤差最小化」を狙うメタヒューリスティックであり、本プロジェクトでは **勾配的性質を抽出して確率性を抑制** し、オンライン最適化に耐える構成とする。  
復帰・始点誘導など「経路外」局面は **Dubins** を用い、切替は上位（sim）で監督する。

---

## 1. 位置付けと依存関係
- **階層内の位置**：`controllers` 層に属し、(v, δ) を生成する上位制御アルゴリズム群の一員。  
- **依存**：  
  - 幾何・誤差指標（CTE, θerr, ωerr）は `trajectory/utils` や `models/geometry` に依拠。  
  - 実行・モード遷移（Dubins誘導／追従の切替）は `sim` で監督。  
  - プロジェクト全体の依存方向（trajectory → controllers → sim）に従う。

---

## 2. インターフェース（I/F）
- **入力**：  
  `state = (x, y, θ, δ_ref, v_ref)`、参照経路（離散点列または局所パス）、現在ステップなど。  
- **出力**：  
  `predict_control = {"delta":[δ*], "accel":[a*]}` の1ステップ提案（N=1の逐次適用）。  
- **利用モード**：  
  - 経路追従フェーズで (v, δ) を逐次最適化。  
  - 逸脱が大きい場合は sim 側の監督で Dubins に切替。

---

## 3. アルゴリズム概要（PSO＋擬似勾配）
1. **粒子初期化**：制御係数ベクトル `kq = (q12,...,q45)` をランダムに生成（必要に応じ前回ベストを温存）。  
2. **粒子評価**：`simulate_particle()` で予測区間 N_STEPS を仮走行し、誤差ログからコスト `J` を算出。  
3. **力学的更新**：  
   - 近傍観測から得た **方向性ベクトル（F, m_F）** で“擬似勾配”を形成（乱数探索のばらつきを抑制）。  
   - 標準PSO項（慣性 w、個体最良 pbest、全体最良 gbest）に **α·F + η·m_F** を加えて粒子速度・位置を更新。  
4. **逐次適用**：反復で得た `best_p` を用いて δ, a を出力。

> この **F / m_F** による方向付けが、ランダム性の影響を減らし「勾配降下に似た安定収束」を与える本構成の肝である。

---

## 4. 評価関数 J（誤差平均＋トレンド＋操舵制約）
- **ログ生成**：各ステップで `cte_log`, `theta_log`, `omega_log`, `steer_log` を記録。  
- **指標**：  
  - **加重平均** `ave_* = γ 重みの和で規格化した平均`（外乱平滑・遅延抑制）。  
  - **差分トレンド** `trend_* = diff(log)`（増勢の抑制）。  
- **合成**：  
```
J = ave_cte/2 + ave_theta/2 + ave_omega/2
+ 2·trend_cte[0] + 2·trend_theta[0] + 2·trend_omega[0]
```
- **操舵制約**：`δ = θ_max · tanh(δ/θ_max/3)` により物理的上限を連続関数で拘束。

> 必要に応じて操舵変化率ペナルティ `mean(diff(steer_log)^2)` を加項し、実機でのジャーク低減を図る想定（将来拡張）。

---

## 5. 主パラメータ
| 項目 | 設定値 | 備考 |
|------|---------|------|
| 予測区間 | N_STEPS = 9 | 短区間先読み |
| 反復回数 | n_iter = 20 | 1制御周期内反復 |
| 粒子数 | N_PARTICLES = 2 | 低負荷設定 |
| PSO係数 | w, c1=1.3, c2=1.3 | α=0.8, β=0.01, η=0.04 |
| 物理制約 | θ_max=±20°, v∈[0.07, 0.28] | tanh制約あり |

---

## 6. 乱数低減と再現性
- **擬似勾配**：局所サンプリングからのベクトル平均（F, m_F）で探索方向を安定化。  
- **tanh拘束**：操舵の非線形ソフト制限で暴走抑制。  
- **seed固定**：`np.random.seed(42)` で再現性を確保（必要に応じて解除）。

---

## 7. 慣性項 w の将来拡張（フック設計）
- **現状**：w 固定（オンライン最適化で十分精度が出ている間は維持）。  
- **将来**：改善率や集団多様性に応じた **適応 w**（探索⇄収束の連続切替）。  
- 改善大 → w↑（惰性維持で加速）  
- 停滞 → w↓（最良に吸引）  
- **実装フック**：`compute_inertia()` 関数で切り替え可能（他ロジック不変）。

---

## 8. Dubins との役割分担・切替方針
| フェーズ | 制御 | 主目的 |
|-----------|-------|--------|
| 誘導（始点・復帰） | Dubins制御 | 経路に“乗る” |
| 追従（経路上） | PSO適応制御 | 経路を“なぞる” |
| 遷移（監督） | simのStateMachine | モード切替 |

**切替条件（例）**  
- TRACK → RECOVER：`|CTE|>CTE_hi` or `|θerr|>THETA_hi` が N_hi ステップ継続。  
- RECOVER → TRACK：`|CTE|<CTE_lo` かつ `|θerr|<THETA_lo` が N_lo ステップ継続。

> モードオーケストレーションは sim 層が担当し、controllers は数理ロジックに専念。

---

## 9. 制約・安全
- 上位仕様（STRUCTURE、controllers責務）に従う。  
- 実機適用時は `θ_max`・`v`・変化率制限を優先し、シミュレーション設定との差異を `models/physics`・`real_vehicle` で吸収。

---

## 10. ログ・検証
- **最小必須ログ**：`cte, theta_err, omega_err, delta, v, cost, best_cost, improve率`。  
- **完走判定**：終点近傍（距離＋姿勢）を連続ホールドで確定。  
- **データ活用**：必要に応じて CSV/Parquet でエクスポートし、オフライン学習に供する（優先度は適応 w に劣後）。

---

## 11. 既知の限界と対処
| 課題 | 対処 |
|------|------|
| 予測範囲外の大逸脱 | Dubins誘導で再合流 |
| 接線不連続（点対点接続） | 高分解能ポリライン化で回避 |
| 最適化時間 | 反復/粒子の縮退、擬似勾配強化、適応w導入 |

---

## UPDATE LOG
- **2025-10-15**：初版作成。  
- PSO適応制御のI/F・評価関数・擬似勾配（F, m_F）・Dubinsとの役割分担・適応wの将来フックを整理。